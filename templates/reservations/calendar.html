{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Reservations" %}{% endblock %}

{% block meta_description %}{% trans "Book your facial treatment appointment at Naomi Face Studio." %}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-12">
    <h1 class="text-4xl font-bold mb-8 text-[#593d09] text-center">{% trans "Book Your Treatment" %}</h1>
    
    {% if not user.is_authenticated %}
    <div class="max-w-2xl mx-auto mb-8 p-6 bg-yellow-50 border border-yellow-200 rounded-lg">
        <p class="text-[#593d09] mb-4">{% trans "You need to create an account to make a reservation." %}</p>
        <a href="{% url 'core:signup' %}?next={{ request.path }}" class="inline-block bg-[#593d09] text-white px-6 py-2 rounded hover:bg-[#4a3207] transition-colors">
            {% trans "Create Account / Login" %}
        </a>
    </div>
    {% endif %}
    
    <div class="max-w-4xl mx-auto">
        <!-- Treatment Selection -->
        <div class="mb-8">
            <label for="treatment_select" class="block mb-2 font-bold text-[#593d09]">{% trans "Select Treatment" %}</label>
            <select id="treatment_select" class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:border-[#593d09]">
                <option value="">{% trans "-- Select Treatment --" %}</option>
                {% for t in treatments %}
                <option value="{{ t.id }}" {% if treatment and treatment.id == t.id %}selected{% endif %}>{{ t.get_title }} - {{ t.get_duration_display }}</option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Calendar -->
        <div id="calendar-container" class="bg-white p-6 rounded-lg shadow-md">
            <!-- Calendar Navigation -->
            <div class="flex items-center justify-between mb-4">
                <button id="prev-month" class="p-2 text-[#593d09] hover:bg-gray-100 rounded transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <h2 id="calendar-month-year" class="text-xl font-bold text-[#593d09]"></h2>
                <button id="next-month" class="p-2 text-[#593d09] hover:bg-gray-100 rounded transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
            </div>
            <div id="calendar" class="mb-6"></div>
            <div id="time-slots" class="grid grid-cols-2 md:grid-cols-4 gap-2"></div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    let selectedDate = null;
    let selectedTreatment = null;
    let availableSlots = [];
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    
    // Treatment selection handler
    document.getElementById('treatment_select').addEventListener('change', function() {
        selectedTreatment = this.value;
        if (selectedTreatment) {
            loadCalendar();
        }
    });
    
    // Month navigation
    document.getElementById('prev-month').addEventListener('click', function() {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        loadCalendar();
    });
    
    document.getElementById('next-month').addEventListener('click', function() {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        loadCalendar();
    });
    
    // Initialize with pre-selected treatment
    {% if treatment %}
    selectedTreatment = {{ treatment.id }};
    document.getElementById('treatment_select').value = {{ treatment.id }};
    loadCalendar();
    {% endif %}
    
    function loadCalendar() {
        // Use today from Croatia timezone (passed from server)
        const todayCroatiaStr = '{{ today_croatia|default:"" }}';
        // For date comparison, use string comparison to avoid timezone issues
        const calendar = document.getElementById('calendar');
        calendar.innerHTML = '';
        
        const monthNames = ['{% trans "January" %}', '{% trans "February" %}', '{% trans "March" %}', '{% trans "April" %}', '{% trans "May" %}', '{% trans "June" %}', '{% trans "July" %}', '{% trans "August" %}', '{% trans "September" %}', '{% trans "October" %}', '{% trans "November" %}', '{% trans "December" %}'];
        const dayNames = ['{% trans "Mon" %}', '{% trans "Tue" %}', '{% trans "Wed" %}', '{% trans "Thu" %}', '{% trans "Fri" %}', '{% trans "Sat" %}', '{% trans "Sun" %}'];
        
        // Update month/year display
        document.getElementById('calendar-month-year').textContent = `${monthNames[currentMonth]} ${currentYear}`;
        
        // Get first day of month and number of days
        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        const adjustedStartingDay = startingDayOfWeek === 0 ? 6 : startingDayOfWeek - 1; // Monday = 0
        
        let calendarHTML = '<div class="grid grid-cols-7 gap-2 mb-2">';
        
        // Day headers
        dayNames.forEach(day => {
            calendarHTML += `<div class="text-center font-bold text-[#593d09] py-2">${day}</div>`;
        });
        calendarHTML += '</div><div class="grid grid-cols-7 gap-2">';
        
        // Empty cells for days before month starts
        for (let i = 0; i < adjustedStartingDay; i++) {
            calendarHTML += '<div class="p-2"></div>';
        }
        
        // Days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(currentYear, currentMonth, day);
            const dayOfWeek = date.getDay();
            const adjustedDay = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            
            // Format date as YYYY-MM-DD for comparison
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const dayStr = String(day).padStart(2, '0');
            const dateStr = `${year}-${month}-${dayStr}`;
            
            // Compare date strings to avoid timezone issues
            const isPast = todayCroatiaStr && dateStr < todayCroatiaStr;
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            const isAvailable = !isPast && !isWeekend;
            const isToday = dateStr === todayCroatiaStr;
            const isSelected = selectedDate === dateStr;
            
            let buttonClass = 'p-2 rounded transition-colors ';
            if (!isAvailable) {
                buttonClass += 'bg-gray-200 text-gray-400 cursor-not-allowed';
            } else if (isSelected) {
                buttonClass += 'bg-[#593d09] text-white';
            } else if (isToday) {
                buttonClass += 'bg-blue-100 text-[#593d09] hover:bg-[#593d09] hover:text-white font-bold';
            } else {
                buttonClass += 'bg-gray-100 text-[#593d09] hover:bg-[#593d09] hover:text-white';
            }
            
            calendarHTML += `
                <button 
                    onclick="selectDate('${dateStr}')" 
                    class="${buttonClass}"
                    ${!isAvailable ? 'disabled' : ''}
                >
                    ${day}
                </button>
            `;
            
            // Start new row if Sunday
            if (adjustedDay === 6 && day < daysInMonth) {
                calendarHTML += '</div><div class="grid grid-cols-7 gap-2">';
            }
        }
        
        calendarHTML += '</div>';
        calendar.innerHTML = calendarHTML;
    }
    
    function selectDate(date) {
        selectedDate = date;
        loadTimeSlots(date);
    }
    
    function loadTimeSlots(date) {
        if (!selectedTreatment) {
            alert('{% trans "Please select a treatment first" %}');
            return;
        }
        
        fetch(`{% url 'reservations:available_slots' %}?treatment_id=${selectedTreatment}&date=${date}`)
            .then(response => response.json())
            .then(data => {
                availableSlots = data.available_slots || [];
                displayTimeSlots();
            })
            .catch(error => {
                console.error('Error:', error);
                const container = document.getElementById('time-slots');
                container.innerHTML = '<p class="text-red-600 p-4 bg-red-50 border border-red-200 rounded">{% trans "Error loading available slots. Please try again." %}</p>';
            });
    }
    
    function displayTimeSlots() {
        const container = document.getElementById('time-slots');
        container.innerHTML = '';
        
        if (availableSlots.length === 0) {
            // Check if there's a reason (closed day, all booked, etc.)
            const selectedDateObj = new Date(selectedDate);
            const dayOfWeek = selectedDateObj.getDay(); // 0=Sunday, 6=Saturday
            
            let message = '{% trans "No available slots for this date" %}';
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                message = '{% trans "This day is closed (Saturday or Sunday)" %}';
            } else {
                message = '{% trans "No available time slots for this date. All slots may be booked." %}';
            }
            
            container.innerHTML = `<p class="text-[#593d09] p-4 bg-yellow-50 border border-yellow-200 rounded">${message}</p>`;
            return;
        }
        
        availableSlots.forEach(slot => {
            const button = document.createElement('button');
            button.className = 'px-4 py-2 bg-gray-100 text-[#593d09] rounded hover:bg-[#593d09] hover:text-white transition-colors';
            button.textContent = slot.start;
            button.onclick = () => bookSlot(slot.start);
            container.appendChild(button);
        });
    }
    
    function bookSlot(startTime) {
        {% if not user.is_authenticated %}
        window.location.href = '{% url "core:signup" %}?next={{ request.path }}';
        return;
        {% endif %}
        
        if (!selectedDate || !selectedTreatment) {
            alert('{% trans "Please select a date and treatment" %}');
            return;
        }
        
        fetch('{% url "reservations:create" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                treatment_id: selectedTreatment,
                date: selectedDate,
                start_time: startTime
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('{% trans "Reservation created successfully!" %}');
                window.location.reload();
            } else {
                alert(data.error || '{% trans "Error creating reservation" %}');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('{% trans "Error creating reservation" %}');
        });
    }
</script>
{% endblock %}
{% endblock %}

